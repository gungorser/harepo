automation:
  - id: climate_schedule
    alias: climate_schedule
    description: ""
    triggers:
      - trigger: calendar
        entity_id: calendar.sercan
        event: start
        offset: "0:0:0"
      - trigger: calendar
        entity_id: calendar.sercan
        event: start
        offset: "+0:30:0"
      - trigger: calendar
        entity_id: calendar.sercan
        event: end
        offset: "0:0:0"
      - trigger: calendar
        entity_id: calendar.sercan
        event: end
        offset: "-0:30:0"
      - trigger: calendar
        entity_id: calendar.melike
        event: start
        offset: "0:0:0"
      - trigger: calendar
        entity_id: calendar.melike
        event: start
        offset: "+0:30:0"
      - trigger: calendar
        entity_id: calendar.melike
        event: end
        offset: "0:0:0"
      - trigger: calendar
        entity_id: calendar.melike
        event: end
        offset: "-0:30:0"
      - trigger: calendar
        entity_id: calendar.misafir
        event: start
        offset: "0:0:0"
      - trigger: calendar
        entity_id: calendar.misafir
        event: start
        offset: "+0:30:0"
      - trigger: calendar
        entity_id: calendar.misafir
        event: end
        offset: "0:0:0"
      - trigger: calendar
        entity_id: calendar.misafir
        event: end
        offset: "-0:30:0"
    conditions: []
    actions:
      - variables:
          event_time: >-
            {% if trigger.event == 'start' %}
              {% set start_no_offset = trigger.calendar_event.start %}
            {% else %}
              {% set start_no_offset = trigger.calendar_event.end %}
            {% endif %}
            {{ as_local(as_datetime(start_no_offset)) + trigger.offset }}
      - action: calendar.get_events
        target:
          entity_id: >-
            {{ states.calendar | map(attribute='entity_id') | list }}
        data:
          start_date_time: "{{ event_time }}"
          duration:
            hours: 0
            minutes: 0
            seconds: 1
        response_variable: after_events
      - action: calendar.get_events
        target:
          entity_id: >-
            {{ states.calendar | map(attribute='entity_id') | list }}
        data:
          start_date_time: "{{ (as_timestamp(event_time)-1) | timestamp_local }}"
          duration:
            hours: 0
            minutes: 0
            seconds: 1
        response_variable: before_events
      - variables:
          room_id: >
            {{ area_id((trigger.calendar_event.description | from_json)['room_name']) }}
          room_temps: >
            {# before ve after icin temps, ikisinin birlikte tutuldugu yer ise temps_all #}
            {% set ns = namespace(temps=[], temps_all=[]) %} 
            {% for events in [before_events, after_events] %}
              {# Temps sifirlanir #}
              {% set ns.temps = [] %} 
              {% set all_events = events.values() | map(attribute='events') | sum(start=[]) | list %}
              {% for event in all_events %}
                {% set desc = event.description | from_json %}
                {# sadece bu eventin odasiyla ilgileniyoruz #}
                {% if area_id(desc['room_name']) == room_id %}
                  {% if 'sleep_temp' in desc 
                      and as_timestamp(event.start) + 1800 <= as_timestamp(event_time) 
                      and as_timestamp(event.end) - 1800 > as_timestamp(event_time) %}
                    {% set ns.temps = ns.temps + [ desc['sleep_temp'] ] %}
                  {% else %}
                    {% set ns.temps = ns.temps + [desc['temp']] %}
                  {% endif %}
                {% endif %}
              {% endfor %}
              {% set ns.temps_all = ns.temps_all + [ ns.temps ] %}
            {% endfor %} 
            {{ ns.temps_all }}
          before: "{{ room_temps[0] | max if room_temps[0] else none }}"
          after: "{{ room_temps[1] | max if room_temps[1] else none }}"
      - if: "{{ before != after }}"
        then:
          - action: climate.set_temperature
            data:
              temperature: "{{ after | int(0) }}"
            target:
              area_id: "{{ room_id }}"
          - action: climate.set_hvac_mode
            data:
              hvac_mode: "{{ 'heat' if after else 'off' }}"
            target:
              area_id: "{{ room_id }}"
    mode: queued
